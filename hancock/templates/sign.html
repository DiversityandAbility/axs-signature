{% extends "base.html" %}

{% block extra_head %}
  <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@latest/dist/svg.min.js"></script>
{% endblock %}

{% block body %}

  <h1 class="text-center text-xl italic py-2">Your Signature is Required</h1>
    <div class="p-4 md:py-6 md:px-14 my-4 md:mx-8 border-2 md:border-8 border-bordercol bg-textbg rounded-lg">
      <p class="py-5">Please review the declaration and add your signature using the textbox provided below. Once you are happy complete the signature by clicking the submit button.</p>
      <h2 class="py-2 font-bold uppercase text-xl">{{ details.title }}</h2>
      <p class="py-4">{{ details.declaration }}</p>
      <p class="text-right mt-2"><a href="{{ details.redirect_uri }}" rel="noopener" target="_blank">Read full document</a></p>

          <form id="signature-form" method="POST">
            <input type="hidden" name="signature" required>
            <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
            
            <label class="font-bold block mb-2">Type in the textbox below to add your signature</label>
            <input class="focus:shadow-xl appearance-none w-full h-14 text-2xl md:text-base rounded border py-2 px-3 leading-tight text-gray-700 shadow" type="text" placeholder="e.g. John Smith" id="name" required />
            
            <p class="text-left pt-6">Signature Preview below:</p>
            
            <div id="signature" class=" flex justify-center mx-auto pb-2 my-2 w-[100%]"></div>
            <div class="text-center py-4">
              <button type="submit" class="rounded text-white font-['Oswald'] font-extrabold tracking-widest uppercase p-4 border-b-4 border-bordercol bg-[#00856C] hover:bg-[#005C4B] text-xl md:text-base">submit<i class="far fa-check-double pl-2"></i></button>
            </div>
            
          </form>
        </div>
      </div>
    </div>


  <script>
    (function() {
      const signatureWidth = 350;
      const signatureHeight = 120;
      let input = document.querySelector('#name');
      let draw = SVG().addTo('#signature').size(signatureWidth, signatureHeight);

      let scale_ = 1.0;
      let textSize_ = 16 * scale_;
      let bg_rect = draw.rect(draw.width(), draw.height()).fill('#ffff');

      let logoW = 40;
      let logoH  = 20;
      if (visualViewport.width < 600 ){
        scale_ = 0.8;
        let mobWidth = signatureWidth * 0.8;
        let mobHeight = signatureHeight * 0.8;
        draw.size(mobWidth, mobHeight);
      }
      visualViewport.addEventListener('resize', function() {
        if (window.innerWidth < 600 ) {
          scale_ = 0.8;
        } else {
          scale_ = 1.0;
        }
        textSize_ = 16 * scale_;
        draw.size(signatureWidth * scale_, signatureHeight * scale_);
        
        text.move(draw.width/2, draw.height * 0.6);
        text.center(draw.width()/2, draw.height()*0.6);
        
        datetime.move(draw.width()* 0.5, draw.height()*0.).font({ "font-size": textSize_, "fill": "#484848", opacity: 0.2 });
        
        hash.move(draw.width() * 0.02, draw.height()*0.85).font({ "font-size": textSize_, "fill": "#484848" });
        
        logo.size(logoW * scale_, logoH * scale_);
      });
      
      draw.center(0,0);

      let fontface = draw.fontface('hancock-cursive', 'url(data:application/font-woff;charset=utf-8;base64,{{ font["base64"] }}) format("woff")', {'font-weight': 'normal', 'font-style': 'normal'});
      
      let text = draw.text(function(add) {
        add.tspan(input.value);
      });

      text.move(draw.width() * 0.5, draw.height() * 0.6);
      text.font({
        family:   'hancock-cursive',
        size:     32, 
        anchor:   'middle',
        leading:  '1.5em'
      });

      input.addEventListener('keyup', updateText);
      function updateText() {
          text.clear();
          text.plain(input.value);
      }

      let datetime = draw.text(function(add) {
        add.tspan(new Date().toLocaleString());
      });


      datetime.move(draw.width()* 0.5, draw.height()*0.).font({ "font-size": textSize_, "fill": "#484848", opacity: 0.2 });
      datetime.width = draw.width();
      function updateDatetime() {
        let timestamp = new Date().toLocaleString();
        timestamp = timestamp.slice(0, -3);
        datetime.clear();
        datetime.plain(timestamp);
      }
      updateDatetime();
      setInterval(updateDatetime, 1000);

      let hash = draw.text(function(add) {
        add.tspan("{{ sid }}");
      });
      hash.move(draw.width() * 0.02, draw.height()*0.85).font({ "font-size": textSize_, "fill": "#484848", opacity: 0.2});
      hash.fill(50);
      
      let logo = SVG(`<svg viewBox="0 0 111.91406 39.300781" version="1.2" id="svg2383" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg">
        <defs id="defs2360">
          <clipPath id="clip2">
            <path d="M 58.867188,46.148438 54.019531,34.316406 49.171875,46.148438 Z M 50.421875,24.671875 h 7.402344 L 73.460938,61.417969 H 65.070312 L 61.734375,53.238281 H 46.304688 l -3.335938,8.179688 h -8.183594 z m 0,0" id="path1771"></path>
          </clipPath>
          <clipPath id="clip4">
            <path d="m 125.06641,23.65625 c -1.73438,0.433594 -3.28125,1.128906 -4.63672,2.082031 -1.35547,0.953125 -2.44141,2.167969 -3.25781,3.644531 -0.81641,1.472657 -1.22657,3.25 -1.22657,5.332032 0,1.875 0.38282,3.402344 1.14844,4.578125 0.76563,1.179687 1.74609,2.144531 2.94531,2.890625 1.19922,0.746094 2.54688,1.34375 4.03907,1.792968 1.49218,0.453126 2.98828,0.886719 4.48437,1.300782 1.5625,0.417968 2.91797,0.792968 4.0625,1.121094 1.14844,0.328124 2.11328,0.691406 2.89453,1.09375 0.78125,0.398437 1.36328,0.855468 1.74609,1.378906 0.38282,0.519531 0.57422,1.195312 0.57422,2.027344 0,0.902343 -0.20312,1.675781 -0.60156,2.316406 -0.39844,0.640625 -0.90234,1.152344 -1.51172,1.535156 -0.60937,0.382812 -1.28515,0.660156 -2.03125,0.832031 -0.75,0.175781 -1.48437,0.261719 -2.21484,0.261719 -2.39844,0 -4.33594,-0.539062 -5.8125,-1.617188 -1.47656,-1.074218 -2.21484,-2.882812 -2.21484,-5.421874 h -8.85938 c 0,1.878906 0.27734,3.511718 0.83203,4.902343 0.55469,1.386719 1.28516,2.59375 2.19141,3.605469 0.90234,1.019531 1.92578,1.839844 3.07422,2.472656 1.14453,0.628906 2.32031,1.136719 3.51562,1.523438 1.19922,0.382812 2.375,0.648437 3.51953,0.789062 1.14844,0.140625 2.15625,0.207032 3.02344,0.207032 1.94531,0 3.86328,-0.214844 5.75781,-0.648438 1.89453,-0.433594 3.59766,-1.128906 5.10938,-2.082031 1.51172,-0.953125 2.73828,-2.210938 3.67578,-3.773438 0.9375,-1.5625 1.40625,-3.46875 1.40625,-5.722656 0,-1.769531 -0.3125,-3.253906 -0.9375,-4.449219 -0.625,-1.199218 -1.45313,-2.195312 -2.47656,-2.992187 -1.02735,-0.800781 -2.19532,-1.449219 -3.51954,-1.953125 -1.32031,-0.503906 -2.6914,-0.945313 -4.11718,-1.328125 -1.39063,-0.34375 -2.75391,-0.675781 -4.08985,-0.988281 -1.33984,-0.3125 -2.53906,-0.667969 -3.59765,-1.066407 -1.0586,-0.398437 -1.92188,-0.882812 -2.57813,-1.457031 -0.66015,-0.574219 -1.01172,-1.328125 -1.04297,-2.261719 0,-0.800781 0.1875,-1.46875 0.57032,-2.003906 0.38281,-0.539063 0.87109,-0.964844 1.46093,-1.277344 0.58985,-0.3125 1.24219,-0.527343 1.95313,-0.648437 0.71484,-0.121094 1.38281,-0.183594 2.00781,-0.183594 0.83594,0 1.66016,0.105469 2.47656,0.3125 0.81641,0.210938 1.53907,0.539062 2.16407,0.992188 0.625,0.449218 1.12109,1.03125 1.48437,1.746093 0.36328,0.710938 0.51172,1.570313 0.44531,2.578125 h 8.44141 c -0.10547,-2.222656 -0.57422,-4.101562 -1.40625,-5.636718 -0.83594,-1.535157 -1.92969,-2.785157 -3.28516,-3.75 -1.35547,-0.960938 -2.91015,-1.65625 -4.66406,-2.074219 -1.75391,-0.421875 -3.62109,-0.632813 -5.60156,-0.632813 -1.8086,0 -3.58203,0.21875 -5.32031,0.652344" id="path1886"></path>
          </clipPath>
          <clipPath id="clip9">
            <path d="M 74.632812,30.726562 86.902344,42.996094 74.632812,55.269531 81.328125,61.964844 100.29297,42.996094 81.328125,24.03125 Z m 0,0" id="path2242"></path>
          </clipPath>
          <clipPath id="clip9-9">
            <path d="M 74.632812,30.726562 86.902344,42.996094 74.632812,55.269531 81.328125,61.964844 100.29297,42.996094 81.328125,24.03125 Z m 0,0" id="path2242-0"></path>
          </clipPath>
        </defs>
        <g id="surface21905" transform="translate(-34.785156,-23.003906)">
          <g clip-path="url(#clip8-0)" clip-rule="nonzero" id="g2380-9" class="fill-primary1" style="fill-opacity:1" transform="matrix(-1,0,0,1,187.21875,0)">
            <g clip-path="url(#clip9-9)" clip-rule="nonzero" id="g2378-9" class="fill-primary1" style="fill-opacity:1">
              <path class="fill-primary1" style="fill-opacity:1;fill-rule:nonzero;stroke:none" d="M 74.632812,24.03125 V 61.964844 H 100.29297 V 24.03125 Z m 0,0" id="path2376-9"></path>
            </g>
          </g>
          <g clip-path="url(#clip1)" clip-rule="nonzero" id="g2366" class="fill-text1" style="fill-opacity:1">
            <g clip-path="url(#clip2)" clip-rule="nonzero" id="g2364" class="fill-text1" style="fill-opacity:1">
              <path class="fill-text1" style="fill-opacity:1;fill-rule:nonzero;stroke:none" d="M 34.785156,24.671875 V 61.417969 H 73.460938 V 24.671875 Z m 0,0" id="path2362"></path>
            </g>
          </g>
          <g clip-path="url(#clip3)" clip-rule="nonzero" id="g2372" class="fill-primary1" style="fill-opacity:1">
            <g clip-path="url(#clip4)" clip-rule="nonzero" id="g2370" class="fill-primary1" style="fill-opacity:1">
              <path class="fill-primary1" style="fill-opacity:1;fill-rule:nonzero;stroke:none" d="M 146.69922,62.304688 V 23.003906 h -32.10547 v 39.300782 z m 0,0" id="path2368"></path>
            </g>
          </g>
          <g clip-path="url(#clip8)" clip-rule="nonzero" id="g2380" class="fill-text1" style="fill-opacity:1">
            <g clip-path="url(#clip9)" clip-rule="nonzero" id="g2378" class="fill-text1" style="fill-opacity:1">
              <path class="fill-text1" style="fill-opacity:1;fill-rule:nonzero;stroke:none color:gray" d="M 74.632812,24.03125 V 61.964844 H 100.29297 V 24.03125 Z m 0,0" id="path2376"></path>
            </g>
          </g>
        </g>
      </svg>`).size(logoW, logoH);
      logo.style('.fill-primary1', {fill: '#585858', opacity: '90%'});
      logo.style('.fill-text1', {fill: '#888888', opacity: '90%'});
      draw.add(logo);
      logo.move(draw.width() * 0.02, draw.height() * 0.02);

      let form = document.getElementById("signature-form");
      form.addEventListener("submit", (evt) => {
        evt.preventDefault();
        
        let url = new URL("/subset/", window.location.origin);
        url.searchParams.append("chars", input.value);
        let req = fetch(url);
        req = req.then(resp => resp.json());
        req.then(font => {
          fontface.remove();
          draw.fontface('hancock-cursive', `url(data:application/font-woff;charset=utf-8;base64,${font.data.base64}) format("woff")`, {'font-weight': 'normal', 'font-style': 'normal'});
          form.querySelector("[name=signature]").value = draw.svg();
          form.submit();
        })
        return false;
      });
    })();
  </script>

{% endblock %}
